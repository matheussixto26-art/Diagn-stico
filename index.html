<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatizador Sala do Futuro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111827; color: #e5e7eb; font-family: 'Inter', sans-serif; }
        .tab-active { border-color: #3b82f6; background-color: #1e40af; }
        .log-entry { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-tag { display: inline-block; padding: 2px 8px; font-size: 0.75rem; border-radius: 9999px; font-weight: 500; margin-left: 8px; }
        .status-rascunho { background-color: #2563eb; color: white; }
        .status-expirada { background-color: #d97706; color: white; }
    </style>
     <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body>

    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

        <div id="login-view" class="w-full max-w-md">
            <div class="bg-gray-800 p-8 rounded-lg shadow-2xl">
                <h1 class="text-3xl font-bold text-center mb-2 text-blue-400">Automatizador</h1>
                <p class="text-center text-gray-400 mb-6">Sala do Futuro</p>
                <form id="login-form" class="space-y-4">
                    <input type="text" id="ra-input" placeholder="Seu RA (com dígito, sem traço)" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="password" id="senha-input" placeholder="Senha" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button id="login-button" type="submit" class="w-full py-3 bg-blue-600 font-semibold rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-500">
                        Entrar
                    </button>
                    <p id="login-message" class="text-red-400 text-sm text-center h-5"></p>
                </form>
            </div>
        </div>

        <div id="dashboard-view" class="hidden w-full max-w-4xl">
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                <header class="flex justify-between items-center pb-4 border-b border-gray-700">
                    <div>
                        <h2 class="text-xl font-bold">Painel de Tarefas</h2>
                        <p id="user-info" class="text-sm text-gray-400">Carregando...</p>
                    </div>
                    <button id="logout-button" class="px-4 py-2 text-sm bg-red-600 rounded-md hover:bg-red-700 transition-colors">Sair</button>
                </header>

                <div id="room-tabs" class="flex space-x-2 py-4 overflow-x-auto">
                    </div>

                <div class="space-y-3 mb-4 h-64 overflow-y-auto pr-2" id="task-list">
                    <p class="text-gray-400">Selecione uma sala para ver as tarefas.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                    <div>
                        <div class="flex items-center mb-2">
                             <input id="select-all" type="checkbox" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                             <label for="select-all" class="ml-2 text-sm">Selecionar Todas na Aba</label>
                        </div>
                        <div class="flex space-x-2">
                           <input id="min-time" type="number" placeholder="Min (s)" value="90" class="w-full px-3 py-1 bg-gray-700 border-gray-600 rounded-md text-sm">
                           <input id="max-time" type="number" placeholder="Max (s)" value="300" class="w-full px-3 py-1 bg-gray-700 border-gray-600 rounded-md text-sm">
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                         <button id="submit-btn" class="w-full py-2 bg-green-600 font-semibold rounded-md hover:bg-green-700 transition-colors disabled:opacity-50">Fazer Tarefas Selecionadas</button>
                         <button id="draft-btn" class="w-full py-2 bg-yellow-600 font-semibold rounded-md hover:bg-yellow-700 transition-colors disabled:opacity-50">Salvar como Rascunho</button>
                    </div>
                </div>

                <div id="progress-log-container" class="mt-4 pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-semibold mb-2">Log de Atividades</h3>
                    <div id="progress-log" class="h-32 bg-gray-900 rounded-md p-3 text-sm font-mono overflow-y-auto">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Estado global da aplicação
            const appState = {
                loginData: null,
                tokenB: null,
                currentRoomId: 'all',
            };

            // Referências de UI
            const ui = {
                loginView: document.getElementById('login-view'),
                dashboardView: document.getElementById('dashboard-view'),
                loginForm: document.getElementById('login-form'),
                raInput: document.getElementById('ra-input'),
                senhaInput: document.getElementById('senha-input'),
                loginButton: document.getElementById('login-button'),
                loginMessage: document.getElementById('login-message'),
                userInfo: document.getElementById('user-info'),
                logoutButton: document.getElementById('logout-button'),
                roomTabs: document.getElementById('room-tabs'),
                taskList: document.getElementById('task-list'),
                selectAllCheckbox: document.getElementById('select-all'),
                minTimeInput: document.getElementById('min-time'),
                maxTimeInput: document.getElementById('max-time'),
                submitBtn: document.getElementById('submit-btn'),
                draftBtn: document.getElementById('draft-btn'),
                progressLog: document.getElementById('progress-log'),
            };

            // --- LÓGICA DE LOGIN E LOGOUT ---

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true, 'Autenticando...');
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: ui.raInput.value, senha: ui.senhaInput.value })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Erro desconhecido no login.');

                    appState.loginData = data;
                    // O token B não vem mais no objeto principal, temos que pegá-lo da troca de token que agora está no backend
                    // Como o backend já usa o tokenB para buscar as tarefas, só precisamos dele no frontend para as requisições futuras
                    // Assumimos que o backend não nos envia mais o tokenB, então vamos ter que adaptar.
                    // CORREÇÃO: O seu backend é um proxy, ele precisa do tokenB que é obtido no login. Vamos assumir que você o retorne no JSON.
                    // Se não retornar, teríamos que fazer a troca de token no frontend, o que é menos seguro.
                    // Para este exemplo, vou simular que o tokenB foi retornado em `data.tokenB`. Você precisaria ajustar seu `login.js` para adicionar `tokenB: tokenB` ao JSON de resposta.
                    // Mas, para fins de teste, vou usar um valor fictício e focar na UI. No seu código real, você já tem acesso a ele.
                    // Vamos passar o tokenB para o estado da aplicação
                    const tokenExchangeResponse = await fetchTokenBFromTokenA(data.tokenA); // Simulação
                    appState.tokenB = data.tokenB; // ESSA É A LINHA CRÍTICA. SEU /api/login PRECISA RETORNAR O tokenB.

                    renderDashboard();
                    ui.loginView.classList.add('hidden');
                    ui.dashboardView.classList.remove('hidden');

                } catch (error) {
                    ui.loginMessage.textContent = `Erro: ${error.message}`;
                } finally {
                    setLoading(false);
                }
            };
            
            // Adicionando uma função para obter o tokenB, caso seu /api/login não o retorne
            // O IDEAL é que o /api/login retorne o tokenB. Adicione "tokenB: tokenB" ao objeto `dashboardData`.
            const handleLoginCorrection = async (e) => {
                 e.preventDefault();
                 setLoading(true, 'Autenticando...');
                 try {
                     const response = await fetch('/api/login', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ user: ui.raInput.value, senha: ui.senhaInput.value })
                     });
                     const data = await response.json(); // Este é o `dashboardData` do seu backend
                     if (!response.ok) throw new Error(data.error || 'Erro desconhecido no login.');

                     // O tokenB é gerado no backend, mas não é retornado. Vamos assumir que ele *é* retornado para o frontend.
                     // Você deve ajustar seu `api/login.js` para incluir `tokenB` no JSON de resposta.
                     // Ex: res.status(200).json({ ...dashboardData, tokenB: tokenB });
                     if (!data.tokenB) { // Adicionando uma verificação
                         throw new Error("O backend não retornou o tokenB necessário para as operações.");
                     }
                     
                     appState.loginData = data;
                     appState.tokenB = data.tokenB; // Armazenando o token B

                     renderDashboard();
                     ui.loginView.classList.add('hidden');
                     ui.dashboardView.classList.remove('hidden');

                 } catch (error) {
                     ui.loginMessage.textContent = `Erro: ${error.message}`;
                 } finally {
                     setLoading(false);
                 }
            }


            const handleLogout = () => {
                appState.loginData = null;
                appState.tokenB = null;
                ui.raInput.value = '';
                ui.senhaInput.value = '';
                ui.dashboardView.classList.add('hidden');
                ui.loginView.classList.remove('hidden');
            };

            // --- RENDERIZAÇÃO DO PAINEL ---

            const renderDashboard = () => {
                const { userInfo, roomUserData } = appState.loginData;
                ui.userInfo.textContent = `Bem-vindo(a), ${userInfo.Nome}.`;
                
                // Renderizar Abas
                ui.roomTabs.innerHTML = `<button data-room-id="all" class="tab-active px-4 py-2 text-sm font-medium rounded-md border-b-2">Todas</button>`;
                roomUserData.rooms.forEach(room => {
                    ui.roomTabs.innerHTML += `<button data-room-id="${room.publication_target}" class="px-4 py-2 text-sm font-medium rounded-md border-b-2 border-transparent hover:bg-gray-700">${room.name}</button>`;
                });

                // Adicionar listeners nas abas
                document.querySelectorAll('#room-tabs button').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelector('#room-tabs .tab-active').classList.remove('tab-active');
                        tab.classList.add('tab-active');
                        appState.currentRoomId = tab.dataset.roomId;
                        renderTaskList();
                    });
                });

                renderTaskList();
            };

            const renderTaskList = () => {
                ui.taskList.innerHTML = '';
                const tasksToDisplay = appState.loginData.tarefas
                    .filter(t => t.answer_status !== 'submitted')
                    .filter(t => {
                        if (appState.currentRoomId === 'all') return true;
                        // A lógica de associação pode ser complexa. Vamos simplificar:
                        return t.publication_target === appState.currentRoomId;
                    });

                if (tasksToDisplay.length === 0) {
                    ui.taskList.innerHTML = '<p class="text-gray-400 p-4 text-center">Nenhuma tarefa pendente nesta sala.</p>';
                    return;
                }

                tasksToDisplay.forEach(task => {
                    let statusTag = '';
                    if (task.task_expired) statusTag = '<span class="status-tag status-expirada">Expirada</span>';
                    if (task.answer_status === 'draft') statusTag = '<span class="status-tag status-rascunho">Rascunho</span>';
                    
                    const taskElementHTML = `
                        <div class="flex items-center bg-gray-900/70 p-3 rounded-md">
                            <input type="checkbox" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-600" data-task-id="${task.id}">
                            <label class="ml-3 flex-grow">${task.title}</label>
                            ${statusTag}
                        </div>
                    `;
                    ui.taskList.innerHTML += taskElementHTML;
                });
            };

            // --- LÓGICA DE AUTOMAÇÃO ---
            
            const handleAutomation = async (submissionStatus) => {
                const selectedCheckboxes = Array.from(ui.taskList.querySelectorAll('.task-checkbox:checked'));
                if (selectedCheckboxes.length === 0) {
                    addLog("⚠️ Nenhuma tarefa selecionada.", 'warn');
                    return;
                }

                setButtonsDisabled(true);
                addLog(`🚀 Iniciando automação para ${selectedCheckboxes.length} tarefa(s) como "${submissionStatus}".`);

                for (const checkbox of selectedCheckboxes) {
                    const taskId = checkbox.dataset.taskId;
                    const taskData = appState.loginData.tarefas.find(t => t.id == taskId);
                    if (!taskData) {
                        addLog(`❌ Erro: Não foi possível encontrar os dados da tarefa ID ${taskId}.`, 'error');
                        continue;
                    }
                    
                    await processSingleTask(taskData, submissionStatus);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Pequena pausa entre tarefas
                }

                addLog("✅ Automação concluída.", 'success');
                setButtonsDisabled(false);
            };

            const processSingleTask = async (taskData, submissionStatus) => {
                const taskName = taskData.title;
                addLog(`▶️ Processando: "${taskName}"`);

                try {
                    // 1. Obter o gabarito
                    addLog(`   - Buscando gabarito...`);
                    const getAnswersPayload = { 
                        taskId: taskData.id, 
                        tokenB: appState.tokenB, 
                        room: taskData.publication_target // Usamos o publication_target da própria tarefa
                    };
                    const answersResponse = await fetch('/api/get-answers', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(getAnswersPayload)
                    });
                    const answersData = await answersResponse.json();
                    if (!answersResponse.ok) throw new Error(answersData.error || 'Falha ao buscar gabarito.');
                    addLog(`   - Gabarito obtido com sucesso.`);

                    // 2. Submeter a tarefa
                    const minTime = parseInt(ui.minTimeInput.value) || 90;
                    const maxTime = parseInt(ui.maxTimeInput.value) || 300;
                    const duration = Math.random() * (maxTime - minTime) + minTime;

                    const submitPayload = { 
                        status: submissionStatus, 
                        answers: answersData.answers, 
                        accessed_on: "room", 
                        executed_on: taskData.publication_target, 
                        duration: parseFloat(duration.toFixed(2))
                    };
                    addLog(`   - Enviando resposta (duração: ${Math.round(duration)}s)...`);
                    const submitResponse = await fetch('/api/submit-task', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ taskId: taskData.id, tokenB: appState.tokenB, payload: submitPayload })
                    });
                    const submitData = await submitResponse.json();
                    if (!submitResponse.ok) throw new Error(submitData.error || 'Falha ao enviar tarefa.');

                    const finalMessage = submissionStatus === 'draft' ? 'Salvo como rascunho!' : `Enviado! Nota: ${submitData.result_score ?? 'N/A'}`;
                    addLog(`✔️ Sucesso para "${taskName}": ${finalMessage}`, 'success');

                } catch (error) {
                    addLog(`❌ Erro em "${taskName}": ${error.message}`, 'error');
                }
            };

            // --- FUNÇÕES UTILITÁRIAS ---

            const setLoading = (isLoading, message = 'Entrar') => {
                ui.loginButton.disabled = isLoading;
                ui.loginButton.textContent = message;
            };

            const setButtonsDisabled = (isDisabled) => {
                ui.submitBtn.disabled = isDisabled;
                ui.draftBtn.disabled = isDisabled;
            };

            const addLog = (message, type = 'info') => {
                const colors = {
                    info: 'text-gray-300',
                    success: 'text-green-400',
                    warn: 'text-yellow-400',
                    error: 'text-red-400',
                };
                const logEntry = document.createElement('p');
                logEntry.className = `log-entry ${colors[type]}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                ui.progressLog.appendChild(logEntry);
                ui.progressLog.scrollTop = ui.progressLog.scrollHeight; // Auto-scroll
            };

            // --- EVENT LISTENERS ---
            ui.loginForm.addEventListener('submit', handleLoginCorrection);
            ui.logoutButton.addEventListener('click', handleLogout);
            ui.submitBtn.addEventListener('click', () => handleAutomation('submitted'));
            ui.draftBtn.addEventListener('click', () => handleAutomation('draft'));
            ui.selectAllCheckbox.addEventListener('change', () => {
                ui.taskList.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.checked = ui.selectAllCheckbox.checked;
                });
            });
        });
    </script>
</body>
</html>
